<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dontPanic:button</title>
    <style>
        body {
            /* font-family: Arial, sans-serif; */
            /*  font-family: 'Roboto Mono', monospace; */
            font-family: 'Poppins', sans-serif;
            margin: 20px;
            /*   background-color: #1E1E1E; */
            color: #a5a5a5;
            background: linear-gradient(to right, #141E30, #243B55);
            /*  background-color: #707b7b; */
        }


        .form-container {
            margin-bottom: 20px;
            padding: 15px;
            /* border: 1px solid #555; */
            border-radius: 8px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            background-color: #2a2a2ac0;
            position: relative;
            box-shadow: 0px 0px 39px -6px rgba(0, 0, 0, 0.3);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #555;
            border-radius: 8px;
            background-color: #ffffff05;
            color: #FFFFFF;
            box-sizing: border-box;
            /*    font-size: 30px; */

        }

        input::placeholder {
            /*   font-size: 20px; */
            text-align: center;

        }

        button {
            padding: 30px 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            background-color: #687585;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 20px;

        }

        button:hover {
            background-color: #728091;

        }

        /* button:active {
            background-color: #00448c;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.6);
            outline: 2px solid rgba(0, 0, 0, 0.3);
        } */

        button[data-state="on"] {
            background-color: #339800;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.6);
            color: white;
        }

        button[data-state="off"] {
            background-color: #1c1c1c;
            color: white;
        }


        .button-container {
            display: flex;
            flex-direction: column;
            /* Stack elements vertically */
            gap: 1px;
            /* Add spacing between elements if needed */
            margin-top: 10px;
        }

        .test-btn {
            width: 100%;
            /* 2/3 width */
        }


        /* Save state style */
        .test-btn.saved,
        button.saved {
            background-color: #339800;
            box-shadow: inset 0 3px 15px rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .test-btn.testing,
        button.testing {
            background-color: #e67f00;
            box-shadow: inset 0 3px 15px rgba(0, 0, 0, 0.8);
            transition: box-shadow 0.4s ease, transform 0.4s ease;
            -webkit-transition: background-color 0.5s ease, transform 0.4s ease;
            -moz-transition: background-color 0.5s ease, transform 0.4s ease;
            -o-transition: background-color 0.5s ease, transform 0.4s ease;
            transition: background-color 0.5s ease, transform 0.4s ease;
        }

        .test-btn.testingUp,
        button.testingUp {
            background-color: #e67f00;

            /*  transform: translateY(-15px); */
            transform: scale(1.05);
            transition: transform 0.2s ease;

        }



        .TestAndSwipe {
            background: linear-gradient(90deg, #2b2b2b, #4a5562, #728091, #93a5bb, #728091, #4a5562, #2b2b2b, #4a5562, #728091, #93a5bb);
            background-size: 300% 100%;
            animation: swipeGradient 3.0s linear infinite, pulseAnimation 3.0s infinite;

        }


        @keyframes swipeGradient {
            0% {
                background-position: 100% 0;
            }

            100% {
                background-position: 0 0;
            }
        }

        @keyframes pulseAnimation {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .enable-btn {
            width: 50%;
            /* 1/3 width */
            padding: 10px 10px;
        }

        .close-btn {
            font-size: 18px;
            cursor: pointer;
        }


        /* Colapsing network settings  container */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .header h2 {
            flex-grow: 1;
            text-align: center;
            margin: 0;
        }

        .toggle-btn {
            font-size: 40px;
            cursor: pointer;
            transition: transform 0.2s ease;
            position: absolute;
            right: 50%;
            top: 45px;

        }

        .form-content {
            display: none;
        }

        .header,
        button {
            -webkit-user-select: none;
            /* Safari */
            -ms-user-select: none;
            /* IE 10 and IE 11 */
            user-select: none;
            /* Standard syntax */
            -webkit-tap-highlight-color: transparent;
            /* Removes the default highlight */
        }

        code {
            /*  background: #f4f4f4; */
            padding: 5px;
            border-radius: 4px;
        }

        .section {
            font-display: center;
            margin-bottom: 20px;
            /*   padding: 1px; */
            /*    border-left: 1px solid#254161; */
            line-height: 1.8;
            /* Increases space between lines */
        }

        .section ul {
            padding-left: 0px;
            /* Increase left padding for more space */
            list-style-position: inside;
            margin: 0px 0;
        }

        .section ul::marker {
            margin: 0;
            /* Removes extra margin from the marker */
        }

        h1,
        h2 {
            text-align: center;
        }

        .section {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        ul li {
            margin-bottom: 8px;
        }

        code {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #ffcc00;
        }

        a {
            color: #a5a5a5;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .form-container {
                padding: 10px;
            }

            code {
                display: inline-block;
                word-wrap: break-word;
            }
        }

        /* Table styling for structured data */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #555;
            text-align: left;
        }
    </style>
</head>

<!-- <body class="style-modern"> -->
<!-- <body class="style-glass"> -->

<body>
    <h1 style="text-align: center;">dontPanic:button</h1>

    <!-- Form for Network Settings -->


    <div class="form-container">
        <!-- <h2>Network Settings</h2> -->
        <div class="header" onclick="toggleFormView()">
            <h2>Network Settings</h2>
            <span class="toggle-btn">&#8722;</span>
        </div>
        <div class="form-content" id="networkSettingsForm">
            <label for="deviceName">Name:</label>
            <input type="text" id="deviceName" name="deviceName" placeholder="">

            <label for="staticIP">Static IP:</label>
            <input type="text" id="staticIP" name="staticIP" class="ip-input" placeholder="Leave blank for dynamic IP">

            <label for="devicePort">Port:</label>
            <input type="text" id="devicePort" name="devicePort" placeholder="">

            <label for="subnet">Subnet:</label>
            <input type="text" id="subnet" name="subnet" class="ip-input" placeholder="(optional)">

            <label for="router">Router:</label>
            <input type="text" id="router" name="router" class="ip-input" placeholder="(optional)">

            <label for="ssid">SSID:</label>
            <input type="text" id="ssid" name="ssid" placeholder="WI-FI Network Name">

            <label for="password">Password:</label>
            <input type="password" id="password" name="password" placeholder="" onmousedown="toggleShowPassword()">
            <!-- </div> -->
            <!-- <div class="form-container"> -->
            <h2>Destination Device</h2>


            <label for="destinationIP">IP:</label>
            <input type="text" id="destinationIP" name="destinationIP" class="ip-input" placeholder="">
            <label for="destinationPort">Port:</label>
            <input type="text" id="destinationPort" name="destinationPort" placeholder="">



            <!-- Save and Reboot Button -->
            <button type="saveAndReboot" id="saveAndReboot">Save Network Settings and
                Reboot</button>
            <!-- <button type="saveAndReboot" id="saveAndReboot" onclick="saveAndReboot()">Save Network Settings and
                Reboot</button> -->
        </div>
    </div>


    <!-- Placeholder for Dynamic Forms -->
    <div id="formPlaceholder"></div>


    <div class="form-container">
        <h1>dontPanic:button UDP Command Guide</h1>

        <div class="section">
            <h2>Companion Commands for Triggers</h2>
            <p>Refer to the Bitfocus
                <a href="https://user.bitfocus.io/docs/companion" target="_blank"> Companion documentation</a> for more.
            </p>
            <p><strong>Default UDP Listening Port:</strong> <code>16759</code></p>
            <table>
                <tr>
                    <th>Command</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>LOCATION &lt;page&gt;/&lt;row&gt;/&lt;column&gt; PRESS</code></td>
                    <td>Press and release a button</td>
                </tr>
                <tr>
                    <td><code>LOCATION &lt;page&gt;/&lt;row&gt;/&lt;column&gt; DOWN</code></td>
                    <td>Press the button (down action)</td>
                </tr>
                <tr>
                    <td><code>LOCATION &lt;page&gt;/&lt;row&gt;/&lt;column&gt; UP</code></td>
                    <td>Release the button (up action)</td>
                </tr>
            </table>


        </div>

        <div class="section">
            <h2>QLab Commands for Triggers</h2>
            <p><strong>Default UDP Listening Port:</strong> <code>53535</code></p>
            <p>QLab interprets UDP messages as OSC commands. Refer to the
                <a href="https://qlab.app/docs/v5/scripting/osc-dictionary-v5/" target="_blank">QLab OSC Dictionary</a>.
            </p>

            <table>
                <tr>
                    <th>Command</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>/cue/{cue_number}/start</code></td>
                    <td>Start the cue</td>
                </tr>
                <tr>
                    <td><code>/cue/{cue_number}/pause</code></td>
                    <td>Pause the cue</td>
                </tr>
                <tr>
                    <td><code>/cue/{cue_number}/go</code></td>
                    <td>Trigger the cue</td>
                </tr>
            </table>

        </div>
        <p><strong>Examples:</strong></p>
        <table>
            <tr>
                <th>Companion Command</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>LOCATION 1/2/3 PRESS</code></td>
                <td>Press button 1/2/3</td>
            </tr>
            <tr>
                <td><code>CUSTOM-VARIABLE cue SET-VALUE intro</code></td>
                <td>Set variable "cue" with value "intro"</td>
            </tr>
            <tr>
                <th>QLab Command</th>
                <th></th>
            </tr>
            <tr>
                <td><code>/cue/1/start</code></td>
                <td>Start cue 1</td>
            </tr>
        </table>
        <div class="section">
            <h2>Return Value Commands</h2>
            <p>You can send UDP messages to <strong>dontPanic:button</strong> and receive replies with device info</p>

            <table>
                <tr>
                    <th>Command</th>
                    <th>Returns</th>
                </tr>
                <tr>
                    <td><code>/isAlive</code></td>
                    <td><code>true</code></td>
                </tr>
                <tr>
                    <td><code>/getPower</code></td>
                    <td>Power type, voltage, and percentage (e.g., <code>usb_4.50_99</code>)</td>
                </tr>
                <tr>
                    <td><code>/getPowerType</code></td>
                    <td><code>batt</code> or <code>usb</code></td>
                </tr>
                <tr>
                    <td><code>/getPowerVoltage</code></td>
                    <td>Voltage (e.g., <code>4.5</code>)</td>
                </tr>
                <tr>
                    <td><code>/getPowerPercentage</code></td>
                    <td>Battery percentage (e.g., <code>95</code>)</td>
                </tr>
                <tr>
                    <td><code>/getNetworkConfig</code></td>
                    <td>String object with configuration</td>
                </tr>
                <tr>
                    <td><code>/getTrigger{trigger_number}</code></td>
                    <td>String object with configuration</td>
                </tr>
            </table>
        </div>

        <div class="section">
            <h2>External Commands</h2>
            <p>You can instruct <strong>dontPanic:button</strong> to send custom messages to a destination device</p>
            <table>
                <tr>
                    <th>Command</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>/trigger/1/down</code></td>
                    <td>Trigger message saved on Trigger 1 down</td>
                </tr>
                <tr>
                    <td><code>/trigger/2/up</code></td>
                    <td>Trigger message saved on on Trigger 2 up</td>
                </tr>
                <tr>
                    <td><code>/command awesome thing here</code></td>
                    <td>Send <code>awesome thing here</code> to a destination device</td>
                </tr>
                <tr>
                    <td><code>/reboot</code></td>
                    <td>Reboots the device</td>
                </tr>
            </table>
        </div>
        <div class="section">
            <h2>Replace Value Commands</h2>

            <table>
                <tr>
                    <th>Companion Replace Value</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>/replaceValue LOCATION &lt;page&gt;/&lt;row&gt;/&lt;column&gt; STYLE TEXT {/getBatteryPercentage}</code>
                    </td>
                    <td>Change button text to battery percentage</td>
                </tr>
                <tr>
                    <td><code>/replaceValue CUSTOM-VARIABLE &lt;name&gt; SET-VALUE {/getWifiRssi}</code></td>
                    <td>Update a custom variable with WiFi RSSI value</td>
                </tr>
                <tr>
                    <th>QLab Replace Value</th>
                    <th></th>
                </tr>
                <tr>
                    <td><code>/replaceValue /cue/{cue_number}/name {/getPowerPercentage}</code>
                    </td>
                    <td>Change text color on a button</td>
                </tr>
                <tr>
                    <td><code>/replaceValue LOCATION &lt;page&gt;/&lt;row&gt;/&lt;column&gt; STYLE BGCOLOR &lt;color HEX&gt;</code>
                    </td>
                    <td>Change background color on a button</td>
                </tr>
            </table>
        </div>
        <p style="text-align: center;">@2025</p>
    </div>


    <script>
        let globalData;
        function validateIP(formIp, element = "") {
            const ipRegex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

            if (!ipRegex.test(formIp) && formIp != "") {
                const isConfirmed = confirm(`Please enter a valid IP address. \n\nmin. 0.0.0.0, \nmax. 255.255.255.255\n\nError with ${element}: ${formIp}`);
                if (!isConfirmed) {
                    throw (`Invalid IP address: ${formIp} for ${element}, user canceled prompt.`);
                }
            }
        }
        function validatePort(destPort, element = "") {
            if (destPort === "") return; // Allow empty string

            const isNumber = /^[0-9]+$/.test(destPort); // Ensure it's only numbers
            const portNumber = parseInt(destPort, 10);

            if (!isNumber || portNumber < 1 || portNumber > 65535) {
                const isConfirmed = confirm(`Please enter a valid port number (1-65535).\n\nError with ${element}: ${destPort}`);
                if (!isConfirmed) {
                    throw (`Invalid port number: ${destPort} for ${element}, user canceled prompt.`);
                }
            }
        }
        function toggleShowPassword() {
            const passwordField = document.getElementById('password');
            passwordField.type = passwordField.type === 'password' ? 'text' : 'password';
        }

        function toggleFormView() {
            const formContent = document.querySelector(".form-content");
            const toggleBtn = document.querySelector(".toggle-btn");

            // Use getComputedStyle to correctly detect initial state
            if (window.getComputedStyle(formContent).display === "none") {
                formContent.style.display = "block";
                toggleBtn.innerHTML = "&#8801;"; // "=" when collapsed
            } else {
                formContent.style.display = "none";
                toggleBtn.innerHTML = "&#8722;"; // "-" when open
            }
        }

        function makeRefreshPage(deviceNetworkConfig) {
            const isDynamicIP = !deviceNetworkConfig.staticIP || deviceNetworkConfig.staticIP === "";
            const savedIP = deviceNetworkConfig.staticIP || "dynamic IP";
            const currentIP = window.location.hostname;

            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            overlay.style.color = '#fff';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '10000';
            overlay.style.fontSize = '20px';
            overlay.style.textAlign = 'center';

            // Add message
            if (currentIP === savedIP) {
                overlay.innerHTML = `<p>Refresh in a few seconds...</p>`;
                const refreshButton = document.createElement('button');
                refreshButton.textContent = `Refresh Now`;
                refreshButton.style.padding = '10px 20px';
                refreshButton.style.marginTop = '20px';
                refreshButton.style.backgroundColor = '#339800';
                refreshButton.style.color = '#fff';
                refreshButton.style.border = 'none';
                refreshButton.style.borderRadius = '5px';
                refreshButton.style.cursor = 'pointer';
                refreshButton.onclick = () => {
                    window.location.reload();
                };
                overlay.appendChild(refreshButton);
            } else {
                overlay.innerHTML = `<p>New IP address</p>`;
                const redirectButton = document.createElement('button');
                redirectButton.textContent = `Go to ${savedIP}`;
                redirectButton.style.padding = '10px 20px';
                redirectButton.style.marginTop = '20px';
                redirectButton.style.backgroundColor = '#339800';
                redirectButton.style.color = '#fff';
                redirectButton.style.border = 'none';
                redirectButton.style.borderRadius = '5px';
                redirectButton.style.cursor = 'pointer';
                redirectButton.onclick = () => {
                    isDynamicIP ? "" : window.location.href = `http://${savedIP}`;
                };
                overlay.appendChild(redirectButton);
            }

            document.body.appendChild(overlay);
        }

        function generateForms({ triggerCount }) {
            const container = document.getElementById('formPlaceholder');
            container.classList.add('triggerGroup');
            container.innerHTML = '';

            for (let btn = 1; btn <= triggerCount; btn++) {
                const buttonContainer = document.createElement('div');
                buttonContainer.classList.add('form-container');
                buttonContainer.id = `trigger${btn}`;

                const buttonHeader = document.createElement('h2');
                buttonHeader.textContent = `Trigger ${btn}`;
                buttonContainer.appendChild(buttonHeader);

                /*  const messageHeader = document.createElement('h3');
                 messageHeader.textContent = `UDP Message`;
                 buttonContainer.appendChild(messageHeader); */

                const downMessageEl = document.createElement('input');
                downMessageEl.type = 'text';
                downMessageEl.id = `downMessageTrigger${btn}`;
                downMessageEl.placeholder = `Down Message`;
                buttonContainer.appendChild(downMessageEl);

                const upMessageEl = document.createElement('input');
                upMessageEl.type = 'text';
                upMessageEl.id = `upMessageTrigger${btn}`;
                upMessageEl.placeholder = `Up Message`;
                buttonContainer.appendChild(upMessageEl);


                // Enabble Btn El
                const buttonGroup = document.createElement('div');
                buttonGroup.classList.add('button-container');
                const toggleButton = document.createElement('button');
                toggleButton.type = 'button';
                toggleButton.classList = 'enable-btn';
                toggleButton.textContent = `Off`;
                toggleButton.id = `enableTrigger${btn}`;
                toggleButton.setAttribute('data-state', 'off');
                toggleButton.onclick = function () {
                    const currentState = this.getAttribute('data-state');
                    if (currentState === 'off') {
                        this.setAttribute('data-state', 'on');
                        this.textContent = `On`;
                        this.style.backgroundColor = '#28a745';
                    } else {
                        this.setAttribute('data-state', 'off');
                        this.textContent = `Off`;
                        this.style.backgroundColor = '#1c1c1c';
                    }
                };





                //Message test/save Btn
                let savedBtnText = `Test`;
                const testSaveButton = document.createElement('button');
                testSaveButton.type = 'button';
                testSaveButton.classList = 'test-btn';
                testSaveButton.textContent = savedBtnText;


                // Handle pointer down (press)
                let touchHoldTimer;

                testSaveButton.addEventListener('pointerdown', () => {
                    savedBtnText = testSaveButton.textContent;
                    touchHoldTimer = setTimeout(() => {
                        test_save_Trigger(btn, buttonContainer, 'down');
                        testSaveButton.textContent = `Testing Down...`;
                        testSaveButton.classList.add('testing');
                    }, 300); // Adjust time (300ms) as needed
                });

                testSaveButton.addEventListener('pointerup', () => {
                    clearTimeout(touchHoldTimer); // Cancel if released early
                });

                testSaveButton.addEventListener('pointerleave', () => {
                    clearTimeout(touchHoldTimer); // Cancel if finger leaves the button
                });


                // Handle pointer up (release)
                testSaveButton.addEventListener('pointerup', () => {
                    test_save_Trigger(btn, buttonContainer, 'up');
                    testSaveButton.textContent = `Testing Up...`;
                    testSaveButton.classList.remove('testing');
                    testSaveButton.classList.add('testingUp');
                    setTimeout(() => {
                        testSaveButton.classList.remove('testingUp');
                        testSaveButton.textContent = savedBtnText;
                    }, 1000);
                });

                toggleButton.addEventListener('click', function () {
                    testSaveButton.textContent = `Test | Swipe to Save`;
                    testSaveButton.classList.add(`TestAndSwipe`);
                });
                downMessageEl.addEventListener('input', function () {
                    testSaveButton.textContent = `Test | Swipe to Save`;
                    testSaveButton.classList.add(`TestAndSwipe`);
                });
                upMessageEl.addEventListener('input', function () {
                    testSaveButton.textContent = `Test | Swipe to Save`;
                    testSaveButton.classList.add(`TestAndSwipe`);
                });



                let touchStartX = 0;
                let touchEndX = 0;
                let swipeThreshold = 200
                // Detect swipe gesture
                testSaveButton.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                testSaveButton.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    if (testSaveButton.classList.contains("TestAndSwipe")) {
                        handleSwipe();
                    }
                });

                testSaveButton.addEventListener('mousedown', (e) => {
                    touchStartX = e.clientX;
                    testSaveButton.width = "200px";
                });

                testSaveButton.addEventListener('mouseup', (e) => {
                    touchEndX = e.clientX;
                    if (testSaveButton.classList.contains("TestAndSwipe")) {
                        handleSwipe();
                    }
                });





                // Handle swipe action
                function handleSwipe() {
                    const swipeDistance = touchEndX - touchStartX;

                    if (Math.abs(swipeDistance) >= swipeThreshold) {
                        if (swipeDistance > 0) {
                            // Swipe Right
                            console.log('Swipe Right detected!');
                            test_save_Trigger(btn, buttonContainer, 'save');  // Trigger save action
                            testSaveButton.classList.remove('testingUp');
                            testSaveButton.classList.remove(`TestAndSwipe`);
                            testSaveButton.classList.remove('testing');

                            testSaveButton.classList.add('saved');
                            //testSaveButton.textContent = 'Message Saved!';
                            testSaveButton.textContent = 'Saving...';
                            setTimeout(() => {
                                testSaveButton.classList.remove('testing');
                                testSaveButton.classList.remove('saved');
                                testSaveButton.textContent = 'Test';
                            }, 1000);
                        }
                    }
                }


                //Enable Btn 
                buttonGroup.appendChild(toggleButton);
                buttonGroup.appendChild(testSaveButton);
                buttonContainer.appendChild(buttonGroup);
                container.appendChild(buttonContainer);

            }

        }




        function saveAndReboot() {
            const deviceNetworkConfig = {
                deviceName: document.getElementById("deviceName").value,
                staticIP: document.getElementById("staticIP").value,
                devicePort: document.getElementById("devicePort").value,
                subnet: document.getElementById("subnet").value,
                router: document.getElementById("router").value,
                ssid: document.getElementById("ssid").value,
                password: document.getElementById("password").value,
                destinationIP: document.getElementById("destinationIP").value,
                destinationPort: document.getElementById("destinationPort").value,
                date: new Date(),
            };




            // Validate IP

            validateIP(deviceNetworkConfig.staticIP, "Device IP");
            validatePort(deviceNetworkConfig.devicePort, "Device Port");
            validateIP(deviceNetworkConfig.subnet, "Subnet IP");
            validateIP(deviceNetworkConfig.router, "Router IP");

            validateIP(deviceNetworkConfig.destinationIP, "Destination IP")
            validatePort(deviceNetworkConfig.destinationPort, "Destination Port");



            // Check if user is sure
            //   if (!confirm("Are you sure you want to reboot?")) { return; };

            let saveAndRebootBtn = document.getElementById("saveAndReboot");
            saveAndRebootBtn.classList.add('saved');
            saveAndRebootBtn.textContent = "Saving and Rebooting...";
            
            saveAndRebootBtn.textContent = 'Saving...';
            /* setTimeout(() => {
                saveAndRebootBtn.classList.remove('saved');
                saveAndRebootBtn.textContent = 'Test';
            }, 1000); */




            console.log(`SAVING Network Settings | data: ${JSON.stringify(deviceNetworkConfig)}`);
            debugLog(`SAVING Network Settings | data: ${JSON.stringify(deviceNetworkConfig)}`);
            //     console.log(deviceNetworkConfig)



            fetch('http://localhost:3000/updateKey', {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    path: `networkConfig`,
                    value: deviceNetworkConfig
                })
            })
                .then(res => res.json())
                .then(data => {
                    console.log("Updated:", data)
                    console.log("Configuration saved. Rebooting...");
                    saveAndRebootBtn.classList.remove('saved');
                    saveAndRebootBtn.classList.remove(`TestAndSwipe`);
                    saveAndRebootBtn.textContent = 'Rebooting...';
                    makeRefreshPage(deviceNetworkConfig)

                    fetch("http://localhost:3000/reboot").then(() => {
                    });
                })
                .catch(err => console.error("Error:", err));
        };


        /**
         * Save the trigger data
         * @param {number} btn The button number
         * @param {HTMLElement} formContainer The form container element
         * @param {'up' | 'down'|'save'} direction The direction of the message or save All elements*
         */
        function test_save_Trigger(btn, formContainer, direction) {
            function extractValues(container) {
                return {

                    [`downMessageTrigger${btn}`]: container.querySelector(`#downMessageTrigger${btn}`)?.value.trim(),
                    [`upMessageTrigger${btn}`]: container.querySelector(`#upMessageTrigger${btn}`)?.value.trim(),
                    [`enableTrigger${btn}`]: container.querySelector(`#enableTrigger${btn}`)?.getAttribute("data-state") === "on" ? true : false,
                    triggerTitle: `trigger${btn}`,
                    triggerNumber: `${btn}`,
                    date: new Date().toISOString(),
                };
            }

            // Example usage:
            const formData = extractValues(formContainer);
            //  console.log(formData);



            if (direction === 'up') {
                // Send the up message
                console.log(`TESTING UP message for ${formData.triggerTitle} | Up Message: ${formData[`upMessageTrigger${btn}`]} | enabled: ${formData[`enableTrigger${btn}`]}`);

                debugLog(`TESTING UP message for ${formData.triggerTitle} | Up Message: ${formData[`upMessageTrigger${btn}`]} | enabled: ${formData[`enableTrigger${btn}`]}`);


            } else if (direction === 'down') {
                // Send the down message
                console.log(`TESTING DOWN message for ${formData.triggerTitle} | Down Message: ${formData[`downMessageTrigger${btn}`]} | enabled: ${formData[`enableTrigger${btn}`]}`);
                debugLog(`TESTING DOWN message for ${formData.triggerTitle} | Down Message: ${formData[`downMessageTrigger${btn}`]} | enabled: ${formData[`enableTrigger${btn}`]}`);
            } else if (direction === 'save') {
                // Save the data
                console.log(`SAVING message for ${formData.triggerTitle} | data: ${JSON.stringify(formData)}`);
                debugLog(`SAVING message for ${formData.triggerTitle}  | data: ${JSON.stringify(formData)}`);

                localStorage.setItem("waitingForReboot", "true"); // Mark reboot in progress

                fetch('http://localhost:3000/updateKey', {
                    method: 'POST',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        path: formData.triggerTitle,
                        value: formData
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        console.log("Updated:", data)

                        fetchConfig();
                    })
                    .catch(err => console.error("Error:", err));
            };
        };




        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        document.addEventListener('DOMContentLoaded', function () {




            /////////////////////////////////////////
            //Generate Trigger Forms dinamicly
            generateForms({ triggerCount: 8 })
            /////////////////////////////////////////




            /////////////////////////////////////////
            // Add event listeners to IP input fields for validation help
            const ipFields = document.querySelectorAll(".ip-input");
            ipFields.forEach(ipField => {
                ipField.addEventListener("input", function () {
                    let value = ipField.value;

                    // Remove non-numeric and non-dot characters
                    value = value.replace(/[^0-9.]/g, "");

                    // Prevent multiple consecutive dots or more than 3 per IP address
                    value = value.replace(/\.{2,}/g, ".");

                    // Ensure correct IP structure by inserting dots
                    let octets = value.split(".");
                    if (octets.length > 4) octets = octets.slice(0, 4); // Limit to 4 octets
                    value = octets.map(octet => octet.substring(0, 3)).join(".");

                    // Update input value
                    ipField.value = value;
                });
            });
            /////////////////////////////////////////
            fetchConfig();
            /////////////////////////////////////////




            /////////////////////////////////////////
            document.getElementById("networkSettingsForm").addEventListener('input', function () {

                let saveAndRebootBtn = document.getElementById("saveAndReboot")
                saveAndRebootBtn.classList.add(`TestAndSwipe`);


                let touchStartX = 0;
                let touchEndX = 0;
                let swipeThreshold = 200
                // Detect swipe gesture
                saveAndRebootBtn.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                saveAndRebootBtn.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    if (saveAndRebootBtn.classList.contains("TestAndSwipe")) {
                        handleSwipe();
                    }
                });

                saveAndRebootBtn.addEventListener('mousedown', (e) => {
                    touchStartX = e.clientX;
                });

                saveAndRebootBtn.addEventListener('mouseup', (e) => {
                    touchEndX = e.clientX;
                    if (saveAndRebootBtn.classList.contains("TestAndSwipe")) {
                        handleSwipe();
                    }
                });
                // Handle swipe action
                function handleSwipe() {

                    const swipeDistance = touchEndX - touchStartX;

                    if (Math.abs(swipeDistance) >= swipeThreshold) {
                        if (swipeDistance > 0) {
                            // Swipe Right
                            console.log('Swipe Right detected!');

                            saveAndReboot();
                            setTimeout(() => {

                            }, 1000);
                        }
                    }
                }
            });
            /////////////////////////////////////////

        });// Func end
        //////////////////////////////////////////////////////////



        //////////////////////////////////////////////////////////
        // Get the initial data from the memory and set page elements
        function fetchConfig() {
            fetch('http://localhost:3000/getConfig')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {

                    console.log("Receive from server:")
                    console.log(data);
                    globalData = data;
                    debugLog("Receive from server success!")

                    const networkConfig = data["networkConfig"];
                    const triggerConfig = Object.keys(data)
                        .filter(key => key.startsWith('trigger'))  // Filter keys that start with 'trigger'
                        .reduce((obj, key) => {
                            obj[key] = data[key];  // Construct a new object with only the trigger keys
                            return obj;
                        }, {});  // Initialize an empty object to store the filtered key-value pairs

                    //console.log(triggerConfig)
                    //Set networkConfig values
                    document.querySelectorAll(".form-content *").forEach(element => {

                        if (element.id && networkConfig[element.id]) {  // Check if ID exists in the data
                            element.value = networkConfig[element.id];  // Set value dynamically
                        }
                    });

                    //////////////////////////////////////////////////////////
                    //Set trigger values
                    document.querySelectorAll(".triggerGroup *").forEach(element => {
                        if (element.id) {
                            // Iterate through triggerConfig object to find a matching key
                            for (const triggerKey in triggerConfig) {
                                const triggerData = triggerConfig[triggerKey];

                                //Set inputs
                                if (triggerData[element.id] !== undefined) {
                                    element.value = triggerData[element.id]; // Set value dynamically

                                    // Set buttons
                                    if (element.type === 'button') {

                                        const currentState = triggerData[element.id] === true ? 'on' : 'off';;
                                        if (currentState === 'on') {
                                            document.getElementById(element.id).setAttribute('data-state', 'on');
                                            document.getElementById(element.id).textContent = `On`;
                                            document.getElementById(element.id).style.backgroundColor = '#28a745';
                                        }
                                    }
                                }
                            }
                        }
                    });


                })
                .catch(error => {
                    // Handle any errors from the fetch request
                    console.error("Error:", error);
                });
        };



        //////////////////////////////////////////////////////////
        // Create debug console
        const debugConsole = document.createElement('div');
        debugConsole.style.position = 'fixed';
        debugConsole.style.bottom = '10px';
        debugConsole.style.right = '10px';
        debugConsole.style.width = '400px';
        debugConsole.style.height = '150px';
        debugConsole.style.background = 'rgba(0,0,0,0.8)';
        debugConsole.style.color = '#fff';
        debugConsole.style.padding = '10px';
        debugConsole.style.overflowY = 'auto';
        debugConsole.style.fontSize = '12px';
        debugConsole.style.zIndex = '10000';
        debugConsole.style.borderRadius = '8px';
        debugConsole.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
        //document.body.appendChild(debugConsole);

        // Function to log messages
        function debugLog(message) {
            /*  const logEntry = document.createElement('div');
             logEntry.textContent = message;
             logEntry.style.marginBottom = "20px"; // Adds space between logs
             debugConsole.appendChild(logEntry);
             debugConsole.scrollTop = debugConsole.scrollHeight; // Auto-scroll to latest */
        }

    </script>
</body>

</html>